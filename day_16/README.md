# Day 16: LangGraph + A2A + Human-in-the-Loop

## æ¦‚è¿°

æœ¬é¡¹ç›®å±•ç¤ºäº†ä¸¤ä¸ªæ ¸å¿ƒèƒ½åŠ›:

1. **LangGraph + A2A** - ä½¿ç”¨ LangGraph æ„å»º Agentï¼Œé€šè¿‡ ADK æš´éœ² A2A æœåŠ¡
2. **Human-in-the-Loop (HITL)** - ç”Ÿäº§çº§äººæœºåä½œå®ç°ï¼Œæ”¯æŒæ•æ„Ÿæ“ä½œå®¡æ‰¹

## ç»ƒä¹ åœºæ™¯ï¼šä¼ä¸š AI åŠ©æ‰‹å®¡æ‰¹ç³»ç»Ÿ

### åœºæ™¯æè¿°

ä¼ä¸šçº§æ„å»º AI åŠ©æ‰‹ï¼Œè¯¥åŠ©æ‰‹å¯ä»¥å¸®åŠ©å‘˜å·¥æ‰§è¡Œå„ç§æ“ä½œã€‚ä½†å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒæŸäº›æ•æ„Ÿæ“ä½œéœ€è¦ç®¡ç†å‘˜å®¡æ‰¹åæ‰èƒ½æ‰§è¡Œã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¼ä¸š AI åŠ©æ‰‹å®¡æ‰¹ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å‘˜å·¥è¯·æ±‚          AI åˆ†æ              ç®¡ç†å‘˜å®¡æ‰¹      æ‰§è¡Œ      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€      â”‚
â”‚                                                                 â”‚
â”‚  "æŸ¥è¯¢é”€å”®æ•°æ®"  â†’  ä½é£é™©  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  ç›´æ¥æ‰§è¡Œ  â”‚
â”‚                                                                 â”‚
â”‚  "ä¿®æ”¹å®¢æˆ·ä¿¡æ¯"  â†’  ä¸­é£é™©  â†’ [ç­‰å¾…å®¡æ‰¹] â†’ æ‰¹å‡† â”€â”€â”€â”€â†’  æ‰§è¡Œä¿®æ”¹  â”‚
â”‚                              â”‚                                  â”‚
â”‚  "åˆ é™¤ç”¨æˆ·è´¦å·"  â†’  é«˜é£é™©  â†’ [ç­‰å¾…å®¡æ‰¹] â†’ æ‹’ç» â”€â”€â”€â”€â†’  æ“ä½œå–æ¶ˆ  â”‚
â”‚                              â”‚                                  â”‚
â”‚  "æ‰¹é‡å‘é€é‚®ä»¶"  â†’  å…³é”®çº§  â†’ [ç­‰å¾…å®¡æ‰¹] â†’ è¶…æ—¶ â”€â”€â”€â”€â†’  è‡ªåŠ¨æ‹’ç»  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çœŸå®åœºæ™¯ç¤ºä¾‹

| å‘˜å·¥è¯·æ±‚ | é£é™©è¯„ä¼° | å¤„ç†æ–¹å¼ |
|----------|----------|----------|
| "å¸®æˆ‘æŸ¥ä¸€ä¸‹ä¸Šä¸ªæœˆçš„é”€å”®æŠ¥è¡¨" | `low` | ç›´æ¥æ‰§è¡Œï¼Œè¿”å›æ•°æ® |
| "æŠŠå®¢æˆ·å¼ ä¸‰çš„æ‰‹æœºå·æ”¹æˆ 138xxx" | `medium` | éœ€è¦å®¡æ‰¹ï¼Œé˜²æ­¢è¯¯æ“ä½œ |
| "åˆ é™¤ç¦»èŒå‘˜å·¥å°ç‹çš„æ‰€æœ‰æ•°æ®" | `high` | å¿…é¡»å®¡æ‰¹ï¼Œä¸å¯é€†æ“ä½œ |
| "ç»™æ‰€æœ‰ VIP å®¢æˆ·å‘é€ä¿ƒé”€é‚®ä»¶" | `critical` | å¿…é¡»å®¡æ‰¹ï¼Œå½±å“èŒƒå›´å¤§ |

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜

> **Agent è‡ªä¸»æ€§ vs å®‰å…¨æ€§çš„å¹³è¡¡**

- å¤ªè‡ªä¸» â†’ å¯èƒ½æ‰§è¡Œå±é™©æ“ä½œï¼Œé€ æˆæŸå¤±
- å¤ªä¿å®ˆ â†’ æ¯ä¸ªæ“ä½œéƒ½è¦å®¡æ‰¹ï¼Œæ•ˆç‡ä½ä¸‹
- **HITL æ–¹æ¡ˆ** â†’ AI è‡ªåŠ¨è¯„ä¼°é£é™©ï¼Œä»…å¯¹é«˜é£é™©æ“ä½œè¦æ±‚å®¡æ‰¹

## æ ¸å¿ƒçŸ¥è¯†ç‚¹

### LangGraph ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    [START] â”€â”€â–º [Node A] â”€â”€â–º [Node B] â”€â”€â–º [END]             â”‚
â”‚                   â”‚            â–²                            â”‚
â”‚                   â””â”€â”€â–º [Node C]â”˜  (æ¡ä»¶è¾¹)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| **State** | å…±äº«å†…å­˜å¯¹è±¡ï¼Œåœ¨æ‰€æœ‰èŠ‚ç‚¹é—´æµè½¬ |
| **Nodes** | æ‰§è¡Œé€»è¾‘çš„å‡½æ•°ï¼Œæ¥æ”¶çŠ¶æ€è¿”å›æ›´æ–° |
| **Edges** | èŠ‚ç‚¹é—´è½¬æ¢ï¼ˆé™æ€è¾¹/æ¡ä»¶è¾¹ï¼‰ |

### Human-in-the-Loop æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Analyze â”‚ â”€â–º â”‚ Classify â”‚ â”€â–º â”‚   Human     â”‚ â”€â–º â”‚ Execute â”‚
â”‚ Request â”‚    â”‚   Risk   â”‚    â”‚   Review    â”‚    â”‚ Action  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                 â”‚
                    â”‚ Low Risk        â”‚ Rejected
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [END]
```

**é£é™©ç­‰çº§:**

| ç­‰çº§ | è¯´æ˜ | æ˜¯å¦å®¡æ‰¹ |
|------|------|----------|
| `low` | åªè¯»æŸ¥è¯¢ï¼Œæ— å‰¯ä½œç”¨ | å¦ |
| `medium` | æ•°æ®ä¿®æ”¹ï¼Œå¯æ’¤é”€ | å¯é…ç½® |
| `high` | æ•°æ®åˆ é™¤ã€å¤–éƒ¨ API è°ƒç”¨ | æ˜¯ |
| `critical` | æ”¯ä»˜ã€æ‰¹é‡æ“ä½œã€ä¸å¯é€† | æ˜¯ + äºŒæ¬¡ç¡®è®¤ |

**æ ¸å¿ƒç‰¹æ€§:**

- **æ–­ç‚¹ç»­è·‘** - æœåŠ¡é‡å¯åå¯ç»§ç»­æ‰§è¡Œï¼ˆéœ€å®‰è£… SQLite æ”¯æŒï¼‰
- **è¶…æ—¶è‡ªåŠ¨æ‹’ç»** - é˜²æ­¢ä»»åŠ¡æ— é™ç­‰å¾…ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰
- **å®Œæ•´å®¡è®¡æ—¥å¿—** - è¿½è¸ªæ‰€æœ‰æ“ä½œ
- **çŠ¶æ€æŒä¹…åŒ–** - ä»»åŠ¡å…ƒæ•°æ®ä¿å­˜åˆ° SQLite

## é¡¹ç›®ç»“æ„

```
day-16/
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ langgraph_agent/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ agent.py           # LangGraph ReAct Agent + A2A
â”‚   â”œâ”€â”€ hitl_agent.py      # Human-in-the-Loop Agent æ ¸å¿ƒ
â”‚   â”œâ”€â”€ checkpointer.py    # çŠ¶æ€æŒä¹…åŒ–
â”‚   â””â”€â”€ server.py          # REST API æœåŠ¡
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ test_client.py     # A2A æµ‹è¯•å®¢æˆ·ç«¯
â”‚   â””â”€â”€ hitl_client.py     # HITL äº¤äº’å®¢æˆ·ç«¯
â””â”€â”€ data/                  # è¿è¡Œæ—¶ç”Ÿæˆ
    â”œâ”€â”€ checkpoints.db     # LangGraph çŠ¶æ€
    â””â”€â”€ tasks.db           # ä»»åŠ¡å…ƒæ•°æ®
```

## è¿è¡Œç¤ºä¾‹

### 1. å®‰è£…ä¾èµ–

```bash
cd day-16
uv pip install -r requirements.txt

# å¯é€‰ï¼šå®‰è£… SQLite æŒä¹…åŒ–æ”¯æŒï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
uv pip install langgraph-checkpoint-sqlite
```

### 2. è¿è¡Œ HITL æœåŠ¡

```bash
uv run python -m langgraph_agent.server
```

è¾“å‡º:
```
============================================================
Day 16: Human-in-the-Loop Agent Server
============================================================

è®¿é—®åœ°å€:
  Web UI:   http://localhost:8016/ui   <- æ¨è
  API Docs: http://localhost:8016/docs

å®¡æ‰¹è¶…æ—¶: 300 ç§’
============================================================
```

### 3. æ‰“å¼€ Web UIï¼ˆæ¨èï¼‰

æµè§ˆå™¨è®¿é—®: **http://localhost:8016/ui**

![Demo](https://fisherai-1312281807.cos.ap-guangzhou.myqcloud.com/CleanShot%202025-12-17%20at%2015.05.12.gif)

Web UI åŠŸèƒ½ï¼š
- ğŸ“ æäº¤è¯·æ±‚ï¼ˆå¸¦å¿«æ·ç¤ºä¾‹æŒ‰é’®ï¼‰
- â³ æŸ¥çœ‹å¾…å®¡æ‰¹ä»»åŠ¡
- âœ…âŒ ä¸€é”®æ‰¹å‡†/æ‹’ç»
- ğŸ“‹ ä»»åŠ¡å†å²å’Œç»Ÿè®¡
- ğŸ” ç‚¹å‡»å†å²è®°å½•æŸ¥çœ‹è¯¦æƒ…

### 4. æˆ–ä½¿ç”¨å‘½ä»¤è¡Œå®¢æˆ·ç«¯

```bash
uv run python -m client.hitl_client
```

### 5. å®Œæ•´æ¼”ç¤ºæµç¨‹

```bash
# 1. å¯åŠ¨æœåŠ¡
uv run python -m langgraph_agent.server

# 2. åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œå®¢æˆ·ç«¯ï¼Œé€‰æ‹© "6. è¿è¡Œæ‰€æœ‰æ¼”ç¤º"
uv run python -m client.hitl_client

# æ¼”ç¤ºåŒ…æ‹¬:
# - ä½é£é™©ä»»åŠ¡ï¼ˆæŸ¥è¯¢å¤©æ°”ï¼‰â†’ è‡ªåŠ¨æ‰§è¡Œ
# - é«˜é£é™©ä»»åŠ¡ï¼ˆåˆ é™¤æ•°æ®ï¼‰â†’ ç­‰å¾…å®¡æ‰¹ â†’ æ‹’ç»
# - ä¸­é£é™©ä»»åŠ¡ï¼ˆå‘é€é‚®ä»¶ï¼‰â†’ ç­‰å¾…å®¡æ‰¹ â†’ æ‰¹å‡†
```

### 6. ä½¿ç”¨ curl æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

```bash
# åœºæ™¯ 1: ä½é£é™©æŸ¥è¯¢ - ç›´æ¥è¿”å›ç»“æœ
curl -X POST http://localhost:8016/tasks \
  -H "Content-Type: application/json" \
  -d '{"message": "æŸ¥è¯¢ä»Šå¤©åŒ—äº¬çš„å¤©æ°”"}'

# åœºæ™¯ 2: é«˜é£é™©æ“ä½œ - éœ€è¦å®¡æ‰¹
curl -X POST http://localhost:8016/tasks \
  -H "Content-Type: application/json" \
  -d '{"message": "åˆ é™¤ç”¨æˆ· test@example.com çš„æ‰€æœ‰æ•°æ®"}'

# æŸ¥çœ‹å¾…å®¡æ‰¹ä»»åŠ¡
curl http://localhost:8016/tasks/pending

# æ‰¹å‡†ä»»åŠ¡ï¼ˆæ›¿æ¢ {task_id}ï¼‰
curl -X POST http://localhost:8016/tasks/{task_id}/approve \
  -H "Content-Type: application/json" \
  -d '{"approved": true, "comment": "å·²ç¡®è®¤ç”¨æˆ·å·²ç¦»èŒ", "approver": "admin"}'

# æˆ–è€…æ‹’ç»
curl -X POST http://localhost:8016/tasks/{task_id}/reject \
  -H "Content-Type: application/json" \
  -d '{"approved": false, "comment": "éœ€è¦å…ˆå¤‡ä»½æ•°æ®", "approver": "admin"}'
```

### 5. è¿è¡ŒåŸæœ‰çš„ A2A æœåŠ¡

```bash
# Terminal 1 - å¯åŠ¨ A2A æœåŠ¡
uv run python -m langgraph_agent.agent

# Terminal 2 - è¿è¡Œæµ‹è¯•
uv run python -m client.test_client
```

## ä»£ç æ ¸å¿ƒ

### 1. HITL Graph æ„å»º

```python
from langgraph.graph import StateGraph, END

class HITLState(TypedDict):
    task_id: str
    messages: Annotated[list, add]
    risk_level: str
    requires_approval: bool
    approval_status: str  # pending, approved, rejected
    final_answer: str

def create_hitl_graph(checkpointer):
    graph = StateGraph(HITLState)

    # æ·»åŠ èŠ‚ç‚¹
    graph.add_node("analyze", analyze_request_node)
    graph.add_node("human_review", human_review_node)
    graph.add_node("execute", execute_action_node)
    graph.add_node("respond", generate_response_node)

    # æ¡ä»¶è·¯ç”±ï¼šæ ¹æ®é£é™©ç­‰çº§å†³å®šæ˜¯å¦éœ€è¦å®¡æ‰¹
    graph.add_conditional_edges(
        "analyze",
        route_after_analysis,
        {"human_review": "human_review", "execute": "execute"}
    )

    # å…³é”®ï¼šåœ¨å®¡æ‰¹èŠ‚ç‚¹å‰ä¸­æ–­ï¼Œç­‰å¾…å¤–éƒ¨è¾“å…¥
    return graph.compile(
        checkpointer=checkpointer,
        interrupt_before=["human_review"],
    )
```

### 2. çŠ¶æ€æŒä¹…åŒ–

```python
from langgraph.checkpoint.memory import MemorySaver
# æˆ–ä½¿ç”¨ SQLiteï¼ˆéœ€è¦å®‰è£… langgraph-checkpoint-sqliteï¼‰
# from langgraph.checkpoint.sqlite import SqliteSaver

checkpointer = MemorySaver()

# å›¾æ‰§è¡Œæ—¶ä½¿ç”¨ thread_id åŒºåˆ†ä¸åŒä¼šè¯
config = {"configurable": {"thread_id": "unique-thread-id"}}
result = graph.invoke(initial_state, config)
```

### 3. å®¡æ‰¹åæ¢å¤æ‰§è¡Œ

```python
def resume_after_approval(task_id, thread_id, approved):
    graph = create_hitl_graph(checkpointer)
    config = {"configurable": {"thread_id": thread_id}}

    # æ³¨å…¥å®¡æ‰¹ç»“æœåˆ°å›¾çŠ¶æ€
    graph.update_state(config, {
        "approval_status": "approved" if approved else "rejected"
    })

    # ä»ä¸­æ–­ç‚¹ç»§ç»­æ‰§è¡Œ
    result = graph.invoke(None, config)
    return result
```

## å…³é”®å­¦ä¹ ç‚¹

1. **interrupt_before** - LangGraph çš„ä¸­æ–­æœºåˆ¶ï¼Œè®©å›¾åœ¨æŒ‡å®šèŠ‚ç‚¹å‰æš‚åœ
2. **Checkpointer** - çŠ¶æ€æŒä¹…åŒ–ï¼Œæ”¯æŒæ–­ç‚¹ç»­è·‘
3. **update_state** - å¤–éƒ¨æ›´æ–°å›¾çŠ¶æ€ï¼Œæ³¨å…¥å®¡æ‰¹ç»“æœ
4. **é£é™©è¯„ä¼°** - LLM è‡ªåŠ¨è¯„ä¼°æ“ä½œé£é™©ç­‰çº§
5. **è¶…æ—¶æœºåˆ¶** - åå°ä»»åŠ¡å®šæœŸæ£€æŸ¥ï¼Œè¶…æ—¶è‡ªåŠ¨æ‹’ç»

## API æ–‡æ¡£

å¯åŠ¨æœåŠ¡åè®¿é—®: http://localhost:8016/docs

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/tasks` | POST | åˆ›å»ºæ–°ä»»åŠ¡ |
| `/tasks` | GET | è·å–ä»»åŠ¡åˆ—è¡¨ |
| `/tasks/pending` | GET | è·å–å¾…å®¡æ‰¹ä»»åŠ¡ |
| `/tasks/{id}` | GET | è·å–ä»»åŠ¡è¯¦æƒ… |
| `/tasks/{id}/approve` | POST | æ‰¹å‡†ä»»åŠ¡ |
| `/tasks/{id}/reject` | POST | æ‹’ç»ä»»åŠ¡ |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

## é…ç½®é¡¹

| ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|----------|--------|------|
| `GOOGLE_API_KEY` | - | Google AI API Key |
| `APPROVAL_TIMEOUT_SECONDS` | 300 | å®¡æ‰¹è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ |
| `HITL_SERVER_URL` | http://localhost:8016 | æœåŠ¡åœ°å€ |

## æ‰©å±•ç»ƒä¹ 

1. **æ·»åŠ æ›´å¤šé£é™©ç±»å‹** - æ‰©å±• `analyze_request_node` æ”¯æŒæ›´ç»†ç²’åº¦çš„é£é™©åˆ¤æ–­
2. **æ¥å…¥çœŸå®å·¥å…·** - å°† `execute_action_node` ä¸­çš„æ¨¡æ‹Ÿæ‰§è¡Œæ›¿æ¢ä¸ºçœŸå® API è°ƒç”¨
3. **æ·»åŠ å®¡æ‰¹å±‚çº§** - é«˜é£é™©éœ€è¦ä¸€çº§å®¡æ‰¹ï¼Œå…³é”®çº§éœ€è¦äºŒçº§å®¡æ‰¹
4. **é›†æˆé€šçŸ¥ç³»ç»Ÿ** - å¾…å®¡æ‰¹æ—¶å‘é€ Slack/é‚®ä»¶é€šçŸ¥ç»™ç®¡ç†å‘˜

## æ‰©å±•é˜…è¯»

- [LangGraph Human-in-the-Loop](https://langchain-ai.github.io/langgraph/concepts/human_in_the_loop/)
- [LangGraph Checkpointing](https://langchain-ai.github.io/langgraph/concepts/persistence/)
- [A2A Protocol](https://a2a-protocol.org/)
